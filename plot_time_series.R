#' @title Plotting Globally Integrated Time Series Data
#' @author Stevie Walker
#' @date 1/25/22
#' @description plots 4 figures of globally integrated time series at 100m, MLDmax, normalized 100m, and normalized MLDmax
#' @description also saves tidied and combined time series data frames


## 1. TIME SERIES AT 100m ---------------

setwd("~/senior_thesis/plotting_dataframes/time_series/")
df.sep <- list.files("~/senior_thesis/plotting_dataframes/time_series/", pattern = "*_time_series.csv$")

#create empty list for storing for loop output
time.series <- list()

for(i in df.sep) {
  
  #read in csv file
  df <- read_csv(i)
  #get rid of random ...1 column
  df <- subset(df, select = -c(...1))
  #store into list
  time.series[[i]] <- df
}

#join by year (2015 has a lot of repeats, but that doesn't effect later plotting)
df <- time.series %>% 
  reduce(left_join, by = "Year")
#delete random extra 2015 rows
df <- df[-c(166:196), ]

#save POC flux at 100m time-series data frame for all models
write_csv(df, file = "~/senior_thesis/plotting_dataframes/time_series/time_series_epc100_all.csv")

#add column for model key (reformatting data specific to the below plot)
df2 <- melt(df,  id.vars = 'Year', value.name = 'POC_flux_100', variable.name = "Model")


#plot time series at 100m
figure <- ggplot(data = df2, aes(x = Year, y = POC_flux_100, color = Model)) +
  geom_line() +
  geom_smooth(size = 0.5, se = FALSE) +
  theme_bw() +
  labs(title = "Time Series Change in Global POC Flux at 100m (1850-2100)") +
  xlab(NULL) +
  ylab("POC Flux (Pg C/yr)") +
  scale_y_continuous(n.breaks = 6)

#save figure
ggsave(filename = "time_series_100m.png", plot = figure, path = "~/senior_thesis/figures/", width = 20, height = 12, units = "cm", dpi = 400)


## 2. TIME SERIES AT MLDMAX -------------------


setwd("~/senior_thesis/plotting_dataframes/time_series/")
df.expc <- list.files("~/senior_thesis/plotting_dataframes/time_series/", pattern = "*_time_series_expc.csv$")

#create empty list for storing for loop output
time.series2 <- list()

for(i in df.expc) {
  
  #read in csv file
  df.expc <- read_csv(i)
  #get rid of random ...1 column
  df.expc <- subset(df.expc, select = -c(...1))
  #store into list
  time.series2[[i]] <- df.expc
}

#join by year (2015 has a lot of repeats, but that doesn't effect later plotting)
df.expc <- time.series2 %>% reduce(left_join, by = "Year")
#add column for model key
df2.expc <- melt(df.expc,  id.vars = 'Year', value.name = 'POC_flux_expc', variable.name = "Model")

#save POC flux at MLDmax time-series data frame for all models
write_csv(df.expc, file = "~/senior_thesis/plotting_dataframes/time_series/time_series_expc_all.csv")

#plot time series at MLDmax
figure2 <- ggplot(data = df2.expc, aes(x = Year, y = POC_flux_expc, color = Model)) +
  geom_line() +
  geom_smooth(size = 0.5, se = FALSE) +
  theme_bw() +
  labs(title = "Time Series Change in Global POC Flux at MLDmax (1850-2100)") +
  xlab(NULL) +
  ylab("POC Flux (Pg C/yr)") +
  scale_y_continuous(n.breaks = 6)

#save figure
ggsave(filename = "time_series_expc.png", plot = figure2, path = "~/senior_thesis/figures/", width = 20, height = 12, units = "cm", dpi = 400)


## 3. NORMALIZED POC FLUX AT 100M RELATIVE TO 1850-1900 MEAN ----------------


#read in df created for first figure
epc100.all <- read_csv("~/senior_thesis/plotting_dataframes/time_series/time_series_epc100_all.csv")

#calculate average for each model from 1850-1900
mean1850_1900 <- dplyr::filter(epc100.all, Year <= 1900) %>% 
  summarise_if(is.numeric, mean)

mean1850_1900 <- subset(mean1850_1900, select = -c(1))

#need to fix year column
normalized.epc100 <- 
  subset(epc100.all, select = -c(1))

#calculate normalized POC flux
normalized.epc100 <- mapply('/', normalized.epc100, mean1850_1900)*100

normalized.epc100 <- normalized.epc100 %>% 
  cbind(Year = c(1850:2100)) %>% 
  as_tibble() %>% 
  relocate(Year, .before = CESM) 

#save df
write_csv(normalized.epc100, "~/senior_thesis/plotting_dataframes/time_series/normalized_time_series_epc100.csv")

#add column for model key (reformatting data specific to the below plot)
plot.normalized.epc100 <- melt(normalized.epc100,  id.vars = 'Year', value.name = 'POC_flux_100', variable.name = "Model")

#plot time series at 100m
figure3 <- ggplot(data = plot.normalized.epc100, aes(x = Year, y = POC_flux_100, color = Model)) +
  geom_line() +
  geom_smooth(size = 0.5, se = FALSE) +
  theme_bw() +
  labs(title = "Percent Change in Global POC Flux at 100m (1850-2100)",
       subtitle = "Relative to 1850-1900 average") +
  xlab(NULL) +
  ylab("Percent Change") +
  scale_y_continuous(limits = c(76, 107), n.breaks = 6)

#save figure
ggsave(filename = "normalized_time_series_100m.png", plot = figure3, path = "~/senior_thesis/figures/", width = 20, height = 12, units = "cm", dpi = 400)


## 4. NORMALIZED POC FLUX AT MLD MAX RELATIVE TO 1850-1900 AVG --------------


#read in df created for first figure
expc.all <- read_csv("~/senior_thesis/plotting_dataframes/time_series/time_series_expc_all.csv")

#calculate average for each model from 1850-1900
mean1850_1900 <- dplyr::filter(expc.all, between(Year, 1850, 1900)) %>% 
  summarise_if(is.numeric, mean)

mean1850_1900 <- subset(mean1850_1900, select = -c(1))

#need to fix year column
normalized.expc <- 
  subset(expc.all, select = -c(1))

#calculate normalized POC flux
normalized.expc <- mapply('/', normalized.expc, mean1850_1900)*100

normalized.expc <- normalized.expc %>% 
  cbind(Year = c(1849:2100)) %>% 
  as_tibble() %>% 
  relocate(Year, .before = CESM) 

#save df
write_csv(normalized.expc, "~/senior_thesis/plotting_dataframes/time_series/normalized_time_series_expc.csv")


#add column for model key (reformatting data specific to the below plot)
plot.normalized.expc <- melt(normalized.expc,  id.vars = 'Year', value.name = 'POC_flux_MLDmax', variable.name = "Model")

#plot time series at 100m
figure4 <- ggplot(data = plot.normalized.expc, aes(x = Year, y = POC_flux_MLDmax, color = Model)) +
  geom_line() +
  geom_smooth(size = 0.5, se = FALSE) +
  theme_bw() +
  labs(title = "Percent Change in Global POC Flux at MLDmax (1850-2100)",
       subtitle = "Relative to 1850-1900 average") +
  xlab(NULL) +
  ylab("Percent Change") +
  scale_y_continuous(limits = c(76, 107), n.breaks = 6)


#save figure
ggsave(filename = "normalized_time_series_MLDmax.png", plot = figure4, path = "~/senior_thesis/figures/", width = 20, height = 12, units = "cm", dpi = 400)


## FACETED NORMALIZED TIME SERIES FIGURE -----------

combined <- grid.arrange(figure3, figure4, ncol = 1)

ggsave(filename = "normalized_time_series_faceted.png", plot = combined, path = "~/senior_thesis/figures/", width = 20, height = 24, units = "cm", dpi = 400)

combined2 <- grid.arrange(figure, figure2, ncol = 1)

ggsave(filename = "time_series_faceted.png", plot = combined2, path = "~/senior_thesis/figures/", width = 20, height = 24, units = "cm", dpi = 400)

