---
title: "Stevie's Senior Thesis"
output: html_notebook
---

1. Load libraries
```{r}
setwd("~/senior_thesis/)

source('libraries.R')

```

2. Using epwshiftr to specify which files to download
```{r}
# NOTE: epwshiftr package may not work with older versions of R (i.e. 3.6.3)

# fill out this format with the variables you need, create the index, then download from index in the next step

# set directory to store files
options(epwshiftr.dir = tempdir())
options(epwshiftr.verbose = TRUE)

# get CMIP6 data nodes
(nodes <- get_data_node())

# create a CMIP6 output file index
idx <- init_cmip6_index(
  # only consider ScenarioMIP activity
  activity = "CMIP",
  
  # specify variables
  variable = c("pp"),
  
  # specify report frequency
  frequency = c("yr"),
  
  # specify experiment name
  experiment = c("historical"),
  
  # specify GCM names
  source = c("GFDL-ESM4"),
  
  # "UKESM1-0-LL", "CMCC-ESM2", "EC-Earth3-CC","GFDL-ESM4","MPI-ESM1-2-HR"
  # specify variant,
  variant = c("r1i1p1f1"),
  
  #"r1i1p1f1","r10i1p1f1","r1i1p1f2"
  
  # save to data directory
  save = FALSE
)

#subset index data frame to only keep the wget url
df <- idx[,21]
#saving CMIP6 data list (rename this every time to the save name of your choice)
write_csv(df,"~/senior_thesis/download_indexes/historical_CMCC_pp.csv")

```

3. Download data files
```{r}

setwd('~/senior_thesis/')
source('libraries.R')
source('get_nc_thredds.R')

#creating save path
save.path <- "~/senior_thesis/cmip6_data"
dir.create(save.path)

#first attempt (got CESM2, CESM2-WACCM, MPI-ESM1-2-HR)
cmip6.index <- read_csv("~/senior_thesis/download_indexes/cmip6_index.csv")
get_nc_thredds(cmip6.index, save.path)

#GFDL download (only MLD)
cmip6.index <- read_csv("~/senior_thesis/download_indexes/cmip6_index_gfdl.csv")
get_nc_thredds(cmip6.index, save.path)

#GFDL download - manually pasted file urls from ESGF search query, failed to connect to node and could not download
cmip6.index <- read_csv("~/senior_thesis/download_indexes/gfdl_urls.csv")
get_nc_thredds(cmip6.index, save.path)

#IPSL download - failed because it could not connect to vesg.ipsl.upmc.fr data node
cmip6.index <- read_csv("~/senior_thesis/download_indexes/cmip6_index_ipsl.csv")
get_nc_thredds(cmip6.index, save.path)

#UKESM download - manually pasted file urls from ESGF search query
cmip6.index <- read_csv("~/senior_thesis/download_indexes/ukesm_urls.csv")
get_nc_thredds(cmip6.index, save.path)

#missing files download
cmip6.index <- read_csv("~/senior_thesis/download_indexes/cmip6_index_gfdl_epc100.csv")
get_nc_thredds(cmip6.index, save.path)

#GFDL mlotst gr
cmip6.index <- read_csv("~/senior_thesis/download_indexes/gfdl_mlotst.csv")
get_nc_thredds(cmip6.index, save.path)

#Download EC Earth,CMCC
cmip6.index <- read_csv("~/senior_thesis/download_indexes/cmip6_index2.csv")
get_nc_thredds(cmip6.index, save.path)


#Download CMCC pp data
cmip6.index <- read_csv("~/senior_thesis/download_indexes/cmip6_CMCC_pp.csv")
get_nc_thredds(cmip6.index,save.path)

#download historical data
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical.csv")
get_nc_thredds(cmip6.index, save.path)

#download GFDL historical data
cmip6.index <- read_csv("~/senior_thesis/download_indexes/GFDL_historical.csv")
get_nc_thredds(cmip6.index, save.path)

#download UKESM historical data
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_UKESM.csv")
get_nc_thredds(cmip6.index, save.path)

#download MPI historical mlotst
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_MPI.csv")
get_nc_thredds(cmip6.index, save.path)

#download EC-Earth historical mlotst and expc
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_EC-Earth.csv")
get_nc_thredds(cmip6.index, save.path)

#historical UKESM expc
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_UKESM_expc.csv")
get_nc_thredds(cmip6.index, save.path)

#CESM historical pp
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_CESM_pp.csv")
get_nc_thredds(cmip6.index, save.path)

#MPI historical pp
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_MPI_pp.csv")
get_nc_thredds(cmip6.index, save.path)

#UKESM historical pp
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_UKESM_pp.csv")
get_nc_thredds(cmip6.index, save.path)

#CMCC historical pp
cmip6.index <- read_csv("~/senior_thesis/download_indexes/historical_CMCC_pp.csv")
get_nc_thredds(cmip6.index, save.path)

```

4. Combine multipart files into a single nc file
```{r}
#after downloading all the files, move them into their corresponding model folder (ex. CESM_data)

## CESM Combine ----------
setwd('~/senior_thesis/')
source('libraries.R')
source('combine_ncfiles.R')

# list of all files with either native grid or regular grid pattern (switch between depending on the model)
model.files <- list.files("~/senior_thesis/CESM_data/", pattern = "*_gn_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/CESM_data/", pattern = "*_gn_*.*nc$") %>% 
  str_split(.,"_gn") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun.
  grep("pp_Oyr_CESM2_historical_r10i1p1f1",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/CESM_data/"
save.path <- "~/senior_thesis/combined_CESM_files/"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)

## GFDL Combine -----------
model.files <- list.files("~/senior_thesis/GFDL_data/", pattern = "*_gr_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/GFDL_data/", pattern = "*_gr_*.*nc$") %>% 
  str_split(.,"_gr") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun. ( Note on 2/8/21)
  grep("pp_Oyr_GFDL-ESM4_historical_r1i1p1f1",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/GFDL_data/"
save.path <- "~/senior_thesis/combined_GFDL_files"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)

## UKESM Combine ----------

# list of all files with gr: "data reported on a model's regular grid"
model.files <- list.files("~/senior_thesis/UKESM_data/", pattern = "*_gn_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/UKESM_data/", pattern = "*_gn_*.*nc$") %>% 
  str_split(.,"_gn") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun. ( Note on 2/8/21)
  grep("pp_Omon_UKESM1-0-LL_historical_r1i1p1f2",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/UKESM_data/"
save.path <- "~/senior_thesis/combined_UKESM_files"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)

##EC Earth Combine --------

# list of all files with gr: "data reported on a model's regular grid"
model.files <- list.files("~/senior_thesis/EC_Earth_data/", pattern = "*_gn_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/EC_Earth_data/", pattern = "*_gn_*.*nc$") %>% 
  str_split(.,"_gn") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun. ( Note on 2/8/21)
  grep("mlotst_Omon_EC-Earth3-CC_historical_r1i1p1f1",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/EC_Earth_data/"
save.path <- "~/senior_thesis/combined_EC-Earth_files"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)

##MPI Combine --------

# list of all files with gr: "data reported on a model's regular grid"
model.files <- list.files("~/senior_thesis/MPI_data/", pattern = "*_gn_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/MPI_data/", pattern = "*_gn_*.*nc$") %>% 
  str_split(.,"_gn") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun. ( Note on 2/8/21)
  grep("pp_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/MPI_data/"
save.path <- "~/senior_thesis/combined_MPI_files"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)

##UKESM Combine -----------

model.files <- list.files("~/senior_thesis/UKESM_data/", pattern = "*_gn_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/UKESM_data/", pattern = "*_gn_*.*nc$") %>% 
  str_split(.,"_gn") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun. ( Note on 2/8/21)
  grep("pp_Omon_UKESM1-0-LL_ssp585_r1i1p1f2",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/UKESM_data/"
save.path <- "~/senior_thesis/combined_UKESM_files"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)

## CMCC Combine -------------
# list of all files with gr: "data reported on a model's regular grid"
model.files <- list.files("~/senior_thesis/cmip6_data/", pattern = "*_gn_*.*nc$") 

# list of unique models and scenarios
model.scenarios <- list.files("~/senior_thesis/cmip6_data/", pattern = "*_gn_*.*nc$") %>% 
  str_split(.,"_gn") %>% 
  unlist %>% 
  #switch between variables and model reps here. You can do this manually here, then rerun. ( Note on 2/8/21)
  grep("pp_Omon_CMCC-ESM2_historical_r1i1p1f1",., value = TRUE) %>% 
  unique()

data.path <- "~/senior_thesis/cmip6_data/"
save.path <- "~/senior_thesis/combined_CMCC_files"
dir.create(save.path)

lapply(model.scenarios,combine_files, model.files, save.path, data.path)


```


5. Get metadata for combined files
```{r}
source('grab_metadata.R')

#CESM
grab_metadata(data.path = "~/senior_thesis/combined_CESM_files",
              model.files = list.files("~/senior_thesis/combined_CESM_files/"))

#GFDL
grab_metadata(data.path = "~/senior_thesis/combined_GFDL_files",
              model.files = list.files("~/senior_thesis/combined_GFDL_files/"))

#MPI
grab_metadata(data.path = "~/senior_thesis/combined_MPI_files",
              model.files = list.files("~/senior_thesis/combined_MPI_files/"))

#CMCC
grab_metadata(data.path = "~/senior_thesis/combined_CMCC_files",
              model.files = list.files("~/senior_thesis/combined_CMCC_files/"))

#EC-Earth
grab_metadata(data.path = "~/senior_thesis/combined_EC-Earth_files",
              model.files = list.files("~/senior_thesis/combined_EC-Earth_files/"))

#UKESM
grab_metadata(data.path = "~/senior_thesis/combined_UKESM_files",
              model.files = list.files("~/senior_thesis/combined_UKESM_files/"))


```


6. Calculate short-term (2014-2034) and long-term (2079-2099) average downward flux of POC at 100m
units: (mol m-2 y-1)
```{r}
setwd("~/senior_thesis/")

source('libraries.R')
source('calc_epc100_avg.R')
source('get_time.R')

#expands prints so you can see all the time steps
options(max.print = 2000)

#create folder to save Rds files (matrices for plotting)
save.path <- "~/senior_thesis/plotting_dataframes"
dir.create(save.path)

## CESM --------------

get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'epc100_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc')
#start date = 09/14/13
#end date = 07/24/99

get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'epc100_Omon_CESM2_historical_r1i1p1f1_gn_185001-201412.nc')

calc_epc100_avg(data.path = "~/senior_thesis/combined_CESM_files/",
                file.name = 'epc100_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc',
                start.st = 17,
                start.lt = 786,
                model.name = "CESM")

calc_epc100_avg_his(data.path = "~/senior_thesis/combined_CESM_files/",
                    file.name = 'epc100_Omon_CESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                    seq.start = 16,
                    model.name = "CESM")


##CMCC -----------

get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'epc100_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc')
#start date = 12/07/14
#end date = 10/16/00

get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'epc100_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc')


calc_epc100_avg(data.path = "~/senior_thesis/combined_CMCC_files/",
                file.name = 'epc100_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
                start.st = 2,
                start.lt = 759,
                model.name = "CMCC")

calc_epc100_avg_his(data.path = "~/senior_thesis/combined_CMCC_files/",
                    file.name = 'epc100_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                    seq.start = 1,
                    model.name = "CMCC")

##EC-Earth ------------

get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'epc100_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc')
#start date = 01/16/15
#end date = 12/16/00

get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'epc100_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc')

calc_epc100_avg(data.path = "~/senior_thesis/combined_EC-Earth_files/",
                file.name = 'epc100_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc',
                start.st = 1,
                start.lt = 757,
                model.name = "EC-Earth")

calc_epc100_avg_his(data.path = "~/senior_thesis/combined_EC-Earth_files/",
                    file.name = 'epc100_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc',
                    seq.start = 1,
                    model.name = "EC-Earth")

##GFDL --------------
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'epc100_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc')
#start date = 12/07/14
#end date = `10/16/00

#historical time
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'epc100_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc')

calc_epc100_avg(data.path = "~/senior_thesis/combined_GFDL_files/",
                file.name = 'epc100_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
                start.st = 2,
                start.lt = 759,
                model.name = "GFDL")

calc_epc100_avg_his(data.path = "~/senior_thesis/combined_GFDL_files/",
                    file.name = 'epc100_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
                    seq.start = 1,
                    model.name = "GFDL")

## MPI --------------
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'epc100_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc')
#start date = 01/16/15
#end date = `12/16/00

get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'epc100_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc')

calc_epc100_avg(data.path = "~/senior_thesis/combined_MPI_files/",
                file.name = 'epc100_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc',
                start.st = 1,
                start.lt = 637,
                model.name = "MPI")

calc_epc100_avg_his(data.path = "~/senior_thesis/combined_MPI_files/",
                    file.name = 'epc100_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc',
                    seq.start = 1,
                    model.name = "MPI")

## UKESM --------
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'epc100_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc')
#start date = 09/03/12
#end date = `05/10/97
#the times on this one are averaged from 01/2077 - 01/2097 instead of 01/2078 - 01/2079 like the other models

get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'epc100_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc')

calc_epc100_avg(data.path = "~/senior_thesis/combined_UKESM_files/",
                file.name = 'epc100_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
                start.st = 30,
                start.lt = 788,
                model.name = "UKESM")

calc_epc100_avg_his(data.path = "~/senior_thesis/combined_UKESM_files/",
                    file.name = 'epc100_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc',
                    seq.start = 1,
                    model.name = "UKESM")
```


7. Plot 3 panel figure showing short-term (2014-2034), long-term (2079-2099), and difference in average downward flux of POC at 100m
```{r}
setwd("~/senior_thesis/")
source('plot_epc100_avg.R')

#CMCC
plot_epc100_avg(wd = "~/senior_thesis/combined_CMCC_files",
                nc_file='epc100_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
                model.name = "CMCC",
                lat.name = "latitude",
                lon.name = "longitude")

#CESM
plot_epc100_avg(wd = "~/senior_thesis/combined_CESM_files",
                nc_file='epc100_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc',
                model.name = "CESM",
                lat.name = "nlat",
                lon.name = "nlon")

#EC-Earth
plot_epc100_avg(wd = "~/senior_thesis/combined_EC-Earth_files",
                nc_file='epc100_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc',
                model.name = "EC-Earth",
                lat.name = "latitude",
                lon.name = "longitude")

#GFDL
plot_epc100_avg(wd = "~/senior_thesis/combined_GFDL_files",
                nc_file='epc100_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
                model.name = "GFDL",
                lat.name = "lat",
                lon.name = "lon")

#MPI - make sure to go in and uncomment the scale_y_continuous lines or else this will plot upside down
plot_epc100_avg(wd = "~/senior_thesis/combined_MPI_files",
                nc_file='epc100_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc',
                model.name = "MPI",
                lat.name = "latitude",
                lon.name = "longitude")

#UKESM
plot_epc100_avg(wd = "~/senior_thesis/combined_UKESM_files",
                nc_file='epc100_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
                model.name = "UKESM",
                lat.name = "latitude",
                lon.name = "longitude")
```


8. Plot 6 panel figure showing change in average POC flux at 100m in 6 models
```{r}
#run this in a R script, for some reason readPNG doesn't work in the notebook

setwd("~/senior_thesis/figures/epc100/")
A <- readPNG('CESM_epc100_change.png')
B <- readPNG('CMCC_epc100_change.png')
C <- readPNG('EC-Earth_epc100_change.png')
D <- readPNG('GFDL_epc100_change.png')
E <- readPNG('MPI_epc100_change.png')
f <- readPNG('UKESM_epc100_change.png')

grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_epc100_avg.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")

```

9. Calculate maximum annual MLD in the short-term (2014-2034), long-term (2077-2097) and historical (1850-1900) units: m
```{r}
setwd("~/senior_thesis/")
source('calc_MLD_max.R')

##CESM -----------
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'mlotst_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc')

calc_MLD_max(wd = "~/senior_thesis/combined_CESM_files", 
             nc.file= 'mlotst_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc',
             seq.start.st = 17, 
             seq.start.lt = 774,
             model.name = "CESM")

get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'mlotst_Omon_CESM2_historical_r10i1p1f1_gn_185001-201412.nc')

calc_MLD_max_his(wd = "~/senior_thesis/combined_CESM_files/",
                 nc.file = 'mlotst_Omon_CESM2_historical_r10i1p1f1_gn_185001-201412.nc',
                 seq.start = 16,
                 model.name = "CESM")

##CMCC ------------
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'mlotst_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc')


calc_MLD_max(wd = "~/senior_thesis/combined_CMCC_files", 
             nc.file= 'mlotst_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
             seq.start.st = 2, 
             seq.start.lt = 759,
             model.name = "CMCC")

get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'mlotst_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc')

calc_MLD_max_his(wd = "~/senior_thesis/combined_CMCC_files/",
                 nc.file = 'mlotst_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                 seq.start = 1,
                 model.name = "CMCC")

##EC-Earth ----------
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'mlotst_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc')

calc_MLD_max(wd = "~/senior_thesis/combined_EC-Earth_files", 
             nc.file= 'mlotst_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc',
             seq.start.st = 1, 
             seq.start.lt = 757,
             model.name = "EC-Earth")

get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'mlotst_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc')

calc_MLD_max_his(wd = "~/senior_thesis/combined_EC-Earth_files/",
                 nc.file = 'mlotst_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc',
                 seq.start = 1,
                 model.name = "EC-Earth")

##GFDL ----------
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'mlotst_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc')

calc_MLD_max(wd = "~/senior_thesis/combined_GFDL_files", 
             nc.file= 'mlotst_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
             seq.start.st = 2, 
             seq.start.lt = 759,
             model.name = "GFDL")

get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'mlotst_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc')

calc_MLD_max_his(wd = "~/senior_thesis/combined_GFDL_files/",
                 nc.file = 'mlotst_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc',
                 seq.start = 1,
                 model.name = "GFDL")

## MPI --------------
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'mlotst_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc')

calc_MLD_max(wd = "~/senior_thesis/combined_MPI_files", 
             nc.file= 'mlotst_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc',
             seq.start.st = 1, 
             seq.start.lt = 697,
             model.name = "MPI")

get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'mlotst_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc')

calc_MLD_max_his(wd = "~/senior_thesis/combined_MPI_files/",
                 nc.file = 'mlotst_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc',
                 seq.start = 1,
                 model.name = "MPI")

## UKESM -------- come back and troubleshoot this
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'mlotst_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc')

calc_MLD_max(wd = "~/senior_thesis/combined_UKESM_files", 
             nc.file= 'mlotst_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
             seq.start.st = 30, 
             seq.start.lt = 785,
             model.name = "UKESM")

get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'mlotst_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc')

calc_MLD_max_his(wd = "~/senior_thesis/combined_UKESM_files/",
                 nc.file = 'mlotst_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc',
                 seq.start = 1,
                 model.name = "UKESM")
```

10. Plot 3 panel figure showing short-term (2014-2034), long-term (2079-2099), and difference in average maximum annual MLD
```{r}
setwd("~/senior_thesis/")
source('plot_MLD_max.R')

#CESM
plot_MLD_max(wd = "~/senior_thesis/combined_CESM_files",
             nc.file = 'mlotst_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc',
             model.name = "CESM",
             lat.name = "nlat",
             lon.name = "nlon")

#CMCC
plot_MLD_max(wd = "~/senior_thesis/combined_CMCC_files",
             nc.file = 'mlotst_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
             model.name = "CMCC",
             lat.name = "latitude",
             lon.name = "longitude")

#EC-Earth
plot_MLD_max(wd = "~/senior_thesis/combined_EC-Earth_files",
             nc.file = 'mlotst_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc',
             model.name = "EC-Earth",
             lat.name = "latitude",
             lon.name = "longitude")

#GFDL
plot_MLD_max(wd = "~/senior_thesis/combined_GFDL_files",
             nc.file = 'mlotst_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
             model.name = "GFDL",
             lat.name = "lat",
             lon.name = "lon")

#MPI - again, this plots upside down, so uncomment the lines in the function
plot_MLD_max(wd = "~/senior_thesis/combined_MPI_files",
             nc.file = 'mlotst_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc',
             model.name = "MPI",
             lat.name = "latitude",
             lon.name = "longitude")

#UKESM
plot_MLD_max(wd = "~/senior_thesis/combined_UKESM_files",
             nc.file = 'mlotst_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
             model.name = "UKESM",
             lat.name = "latitude",
             lon.name = "longitude")

```

11. Plot 6 panel figure showing change in MLDmax for all 6 models
```{r}
#run this in a R script, for some reason readPNG doesn't work in the notebook

setwd("~/senior_thesis/figures/")
A <- readPNG('CESM_MLDmax_change.png')
B <- readPNG('CMCC_MLDmax_change.png')
C <- readPNG('EC-Earth_MLDmax_change.png')
D <- readPNG('GFDL_MLDmax_change.png')
E <- readPNG('MPI_MLDmax_change.png')
f <- readPNG('UKESM_MLDmax_change.png')

grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_MLDmax.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")

```


12. Calculate POC flux at the MLDmax
```{r}
setwd("~/senior_thesis/")
source('libraries.R')
source('calc_expc_avg.R')
source('get_time.R')

#every model but UKESM was averaged from 2015-2035 and 2079-2099, UKESM was 2015-2035 and 2077-2097
#be sure to get the right time steps before you calculate

## CESM --------------

#go into function and convert from cm to m (just for this model)

#start = 03/01/14, end = 02/08/99
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc')

calc_expc_avg(wd = "~/senior_thesis/combined_CESM_files",
              nc.file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
              model.name = "CESM",
              start.st = 2,
              start.lt = 66,
              lon.length = 1:320,
              lat.length = 1:384)

#historical
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'expc_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc')

calc_expc_avg_his(wd = "~/senior_thesis/combined_CESM_files/",
                  nc.file = 'expc_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc',
                  model.name = "CESM",
                  start.st = 2,
                  lon.length = 1:320,
                  lat.length = 1:384)

#remember to re-comment 100m line

## CMCC ----------------

#start = 05/23/15, end = 05/02/00
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc')

calc_expc_avg(wd = "~/senior_thesis/combined_CMCC_files",
              nc.file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
              model.name = "CMCC",
              start.st = 1,
              start.lt = 65,
              lon.length = 1:362,
              lat.length = 1:292)

#historical
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'expc_Oyr_CMCC-ESM2_historical_r1i1p1f1_gn_1850-2014.nc')

calc_expc_avg_his(wd = "~/senior_thesis/combined_CMCC_files/",
                  nc.file = 'expc_Oyr_CMCC-ESM2_historical_r1i1p1f1_gn_1850-2014.nc',
                  model.name = "CMCC",
                  start.st = 1,
                  lon.length = 1:362,
                  lat.length = 1:292)

##EC-Earth ----------

#start = 07/02/15, 07/02/00
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/", file.name = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc')

calc_expc_avg(wd = "~/senior_thesis/combined_EC-Earth_files",
              nc.file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
              model.name = "EC-Earth",
              start.st = 1,
              lon.length = 1:362,
              lat.length = 1:292)

#historical
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'expc_Oyr_EC-Earth3-CC_historical_r1i1p1f1_gn_1850-2014.nc')

calc_expc_avg_his(wd = "~/senior_thesis/combined_EC-Earth_files/",
                  nc.file = 'expc_Oyr_EC-Earth3-CC_historical_r1i1p1f1_gn_1850-2014.nc',
                  model.name = "EC-Earth",
                  start.st = 1,
                  lon.length = 1:362,
                  lat.length = 1:292)

##GFDL -------

get_time(data.path = "~/senior_thesis/combined_GFDL_files/", file.name = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc')

calc_expc_avg(wd = "~/senior_thesis/combined_GFDL_files",
              nc.file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
              model.name = "GFDL",
              start.st = 1,
              start.lt = 65,
              lon.length = 1:360,
              lat.length = 1:180)

#historical
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'expc_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc')

calc_expc_avg_his(wd = "~/senior_thesis/combined_GFDL_files/",
                  nc.file = 'expc_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc',
                  model.name = "GFDL",
                  start.st = 1,
                  lon.length = 1:360,
                  lat.length = 1:180)


##MPI --------

#start = 07/02/15, end = 07/02/00
get_time(data.path = "~/senior_thesis/combined_MPI_files/", file.name = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc')

calc_expc_avg(wd = "~/senior_thesis/combined_MPI_files",
              nc.file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
              model.name = "MPI",
              start.st = 1,
              start.lt = 65,
              lon.length = 1:802,
              lat.length = 1:404)

#historical
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'expc_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc')

calc_expc_avg_his(wd = "~/senior_thesis/combined_MPI_files/",
                  nc.file = 'expc_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc',
                  model.name = "MPI",
                  start.st = 1,
                  lon.length = 1:802,
                  lat.length = 1:404)

##UKESM ----------

#UKESM get time long-term, start = 03/04/47, end = 05/10/97
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_205001-210012.nc')
#UKESM get time short-term, start = 09/03/12, end = 02/02/47
get_time(data.path = "~/senior_thesis/UKESM_data/",
         file.name = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc')
#UKESM historical time
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc')

#custom calculation for UKESM since I had to take the yearly average within the calc_expc_avg function
source('calc_expc_st_UKESM.R')
source('calc_expc_lt_UKESM.R')
source('calc_expc_his_UKESM.R')

#save matrices for plotting
setwd("~/senior_thesis/plotting_dataframes/")
#find change in POC flux 
mean_expc_his <- readRDS("~/senior_thesis/plotting_dataframes/UKESM_mean_expc_his.Rds")
mean_expc_lt <- readRDS("~/senior_thesis/plotting_dataframes/UKESM_mean_expc_lt.Rds")

expc_change = mean_expc_lt - mean_expc_his

#save change in POC flux at MLDmax matrix
saveRDS(expc_change, file = "UKESM_expc_change.Rds", ascii = TRUE)

```

13. Plot 3 panel figure showing short-term (2015-2035), long-term (2079-2099), and difference in average POC flux at the MLDmax
```{r}
setwd("~/senior_thesis/")
source('plot_expc_avg.R')

#CESM

plot_expc_avg(wd = "~/senior_thesis/combined_CESM_files",
              nc_file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
              model.name = "CESM",
              lat.name = "nlat",
              lon.name = "nlon")

#CMCC
plot_expc_avg(wd = "~/senior_thesis/combined_CMCC_files",
              nc_file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
              model.name = "CMCC",
              lat.name = "latitude",
              lon.name = "longitude")

#EC-Earth
plot_expc_avg(wd = "~/senior_thesis/combined_EC-Earth_files",
              nc_file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
              model.name = "EC-Earth",
              lat.name = "latitude",
              lon.name = "longitude")

#GFDL
plot_expc_avg(wd = "~/senior_thesis/combined_GFDL_files",
              nc_file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
              model.name = "GFDL",
              lat.name = "lat",
              lon.name = "lon")

#MPI
plot_expc_avg(wd = "~/senior_thesis/combined_MPI_files",
              nc_file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
              model.name = "MPI",
              lat.name = "latitude",
              lon.name = "longitude")

#UKESM
plot_expc_avg(wd = "~/senior_thesis/UKESM_data",
              nc_file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
              model.name = "UKESM",
              lat.name = "latitude",
              lon.name = "longitude")
```

14. Plot 6 panel figure showing POC flux change at MLDmax for all models
```{r}
setwd("~/senior_thesis/figures/")
A <- readPNG('CESM_expc_change.png')
B <- readPNG('CMCC_expc_change.png')
C <- readPNG('EC-Earth_expc_change.png')
D <- readPNG('GFDL_expc_change.png')
E <- readPNG('MPI_expc_change.png')
f <- readPNG('UKESM_expc_change.png')


grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_expc.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")
```

15. Calculate and plot change in POC flux difference (MLDmax - 100m) - 3 panel fig for each model and 6 panel fig of all models 
```{r}
setwd('~/senior_thesis')
source('calc_depth_horizon_diff.R')
source('plot_depth_horizon_diff.R')

calc_depth_horizon_diff("CESM")
calc_depth_horizon_diff("CMCC")
calc_depth_horizon_diff("EC-Earth")
calc_depth_horizon_diff("GFDL")
calc_depth_horizon_diff("MPI")
calc_depth_horizon_diff("UKESM")

#CESM
plot_depth_horizon_diff(wd = "~/senior_thesis/combined_CESM_files",
                        nc_file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                        model.name = "CESM",
                        lat.name = "nlat",
                        lon.name = "nlon")

#CMCC
plot_depth_horizon_diff(wd = "~/senior_thesis/combined_CMCC_files",
                        nc_file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                        model.name = "CMCC",
                        lat.name = "latitude",
                        lon.name = "longitude")

#EC-Earth
plot_depth_horizon_diff(wd = "~/senior_thesis/combined_EC-Earth_files",
                        nc_file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                        model.name = "EC-Earth",
                        lat.name = "latitude",
                        lon.name = "longitude")

#GFDL
plot_depth_horizon_diff(wd = "~/senior_thesis/combined_GFDL_files",
                        nc_file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                        model.name = "GFDL",
                        lat.name = "lat",
                        lon.name = "lon")

#UKESM
plot_depth_horizon_diff(wd = "~/senior_thesis/UKESM_data",
                        nc_file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
                        model.name = "UKESM",
                        lat.name = "latitude",
                        lon.name = "longitude")

#MPI
plot_depth_horizon_diff(wd = "~/senior_thesis/combined_MPI_files",
                        nc_file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                        model.name = "MPI",
                        lat.name = "latitude",
                        lon.name = "longitude")

## 6 panel fig -------

setwd("~/senior_thesis/figures/DH_diff/")
A <- readPNG('CESM_expc-epc100.png')
B <- readPNG('CMCC_expc-epc100.png')
C <- readPNG('EC-Earth_expc-epc100.png')
D <- readPNG('GFDL_expc-epc100.png')
E <- readPNG('MPI_expc-epc100.png')
f <- readPNG('UKESM_expc-epc100.png')


grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E), rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_expc-epc100.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")


```


16. Plot CESM depth profiles in various locations
```{r}
setwd("~/senior_thesis/combined_CESM_files/")
nc_data <- nc_open('expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc')

#NOTE: this section won't run in the notebook, so paste these lines into a script and run first before sourcing function

#get expc in 2014-2034
variable.st <- ncvar_get(nc_data,"expc",start= c(1,1,1,1), count = c(-1,-1,-1,20))

#get expc in 2079-2099
variable.lt <- ncvar_get(nc_data,"expc",start= c(1,1,1,66), count = c(-1,-1,-1,20))

#calcuates short-term average POC flux over 20 years, still including the entire water column averages
avg_expc_st <- apply(variable.st,c(1,2,3),mean,na.rm=TRUE)

#calcuates short-term average POC flux over 20 years, still including the entire water column averages
avg_expc_lt <- apply(variable.lt,c(1,2,3),mean,na.rm=TRUE)

#saves these arrays as .rds files so they are easier to load next time I need them
setwd("~/senior_thesis/plotting_dataframes/")
saveRDS(avg_expc_st, file = "avg_expc_st.Rds", ascii = TRUE)
saveRDS(avg_expc_lt, file = "avg_expc_lt.Rds", ascii = TRUE)

#end section

source('~/senior_thesis/depth_profiles.R')

#load short-term and long-term average POC flux arrays
avg_expc_st <- readRDS("~/senior_thesis/plotting_dataframes/avg_expc_st.Rds")  
avg_expc_lt <- readRDS("~/senior_thesis/plotting_dataframes/avg_expc_lt.Rds")

# LABRADOR SEA 
profile_create(grid.cell = c(305,355), depth.range = c(3000,0), expc.range = c(0,4), 
               title = "a) Labrador Sea",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "labrador_sea_depth_profile")

# EQUATORIAL EASTERN PACIFIC
profile_create(grid.cell = c(274,184), depth.range = c(3200,0), expc.range = c(0,13), 
               title = "c) Equatorial Eastern Pacific",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "equatorial_eastern_pacific_depth_profile")

# SOUTHERN OCEAN
profile_create(grid.cell = c(99,63), depth.range = c(3000,0), expc.range = c(0,4), 
               title = "e) Southern Ocean",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "southern_ocean_depth_profile")

# SUBTROPICAL INDIAN OCEAN (not using in thesis)
profile_create(grid.cell = c(120,150), depth.range = c(5000,0), expc.range = c(0,4), 
               title = "Subtropical Indian Ocean",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "subtropical_indian_ocean_depth_profile")

# ICELAND BASIN
profile_create(grid.cell = c(30,352), depth.range = c(1200,0), expc.range = c(0,5), 
               title = "b) Iceland Basin",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "iceland_basin_depth_profile")

#SUBTROPICAL NORTH PACIFIC
profile_create(grid.cell = c(230,275), depth.range = c(5000,0), expc.range = c(0,1.5), 
               title = "d) Subtropical North Pacific",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "subtropical_north_pacific_depth_profile")

# BELLINGHAUSEN SEA
profile_create(grid.cell = c(276,21), depth.range = c(3300,0), expc.range = c(0,2), 
               title = "f) Bellingshausen Sea",
               data.path = "~/senior_thesis/combined_CESM_files/", 
               save.path = "~/senior_thesis/depth_profiles",
               save.name = "bellinghausen_sea_depth_profile")

#arranging into 6 panel figure (NOTE: run this in a separate script, there's a glitch in readPNG)
setwd("~/senior_thesis/depth_profiles/")
A <- readPNG('labrador_sea_depth_profile.png')
B <- readPNG('iceland_basin_depth_profile.png')
C <- readPNG('equatorial_eastern_pacific_depth_profile.png')
D <- readPNG('subtropical_north_pacific_depth_profile.png')
E <- readPNG('southern_ocean_depth_profile.png')
f <- readPNG('bellinghausen_sea_depth_profile.png')

grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_depth_profiles.png", device = "png", path = "~/senior_thesis/depth_profiles/faceted/", 
       dpi = 500, width = 16, height = 22, units = "cm")

```

17. Organizing depth profile output for table info
```{r}
#combine table output csv files into one file
files <- list.files("~/senior_thesis/depth_profiles/", pattern = "*.csv$")
setwd("~/senior_thesis/depth_profiles/")
read.files <- lapply(files,read_csv)
binded_file <- rbindlist(read.files, fill = TRUE)
write.csv(binded_file, "table_info.csv")

```

18. Calculate global POC flux at 100m and MLDmax
```{r}
setwd("~/senior_thesis/")
source('global_POC_flux.R')

#downloading CESM cell area files
save.path <- "~/senior_thesis/cmip6_data"

cmip6.index <- "http://esgf-data.ucar.edu/thredds/fileServer/esg_dataroot/CMIP6/ScenarioMIP/NCAR/CESM2/ssp585/r10i1p1f1/Ofx/areacello/gn/v20200528/areacello_Ofx_CESM2_ssp585_r10i1p1f1_gn.nc"

get_nc_thredds(cmip6.index, save.path)

#Calculate global CESM fluxes
global_flux(wd = "~/senior_thesis/combined_CESM_files",
            nc.file = 'areacello_Ofx_CESM2_ssp585_r10i1p1f1_gn.nc',
            model.name = "CESM")


#Downloading MPI data
cmip6.index <- "http://esgf3.dkrz.de/thredds/fileServer/cmip6/ScenarioMIP/DKRZ/MPI-ESM1-2-HR/ssp585/r1i1p1f1/Ofx/areacello/gn/v20190710/areacello_Ofx_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn.nc"

get_nc_thredds(cmip6.index, save.path)

global_flux(wd = "~/senior_thesis/cmip6_data",
            nc.file = 'areacello_Ofx_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn.nc',
            model.name = "MPI")

#Downloading EC-Earth data

get_nc_thredds(cmip6.index = "http://esg-dn2.nsc.liu.se/thredds/fileServer/esg_dataroot1/cmip6data/CMIP6/CMIP/EC-Earth-Consortium/EC-Earth3/historical/r1i1p1f1/Ofx/areacello/gn/v20200918/areacello_Ofx_EC-Earth3_historical_r1i1p1f1_gn.nc", save.path = "~/senior_thesis/cmip6_data")

global_flux(wd = "~/senior_thesis/cmip6_data",
            nc.file = 'areacello_Ofx_EC-Earth3_historical_r1i1p1f1_gn.nc',
            model.name = "EC-Earth")

#UKESM - download and calculation
get_nc_thredds(cmip6.index = "http://esgf-data3.ceda.ac.uk/thredds/fileServer/esg_cmip6/CMIP6/CMIP/MOHC/UKESM1-0-LL/piControl/r1i1p1f2/Ofx/areacello/gn/v20190705/areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc", save.path = "~/senior_thesis/cmip6_data")

global_flux(wd = "~/senior_thesis/cmip6_data",
            nc.file = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
            model.name = "UKESM")

#CMCC - download and calculation

get_nc_thredds(cmip6.index = "http://esgf-node2.cmcc.it/thredds/fileServer/esg_dataroot/CMIP6/CMIP/CMCC/CMCC-ESM2/historical/r1i1p1f1/Ofx/areacello/gn/v20210114/areacello_Ofx_CMCC-ESM2_historical_r1i1p1f1_gn.nc", save.path = "~/senior_thesis/cmip6_data")

global_flux(wd = "~/senior_thesis/cmip6_data",
            nc.file = 'areacello_Ofx_CMCC-ESM2_historical_r1i1p1f1_gn.nc',
            model.name = "CMCC")

#GFDL - download and calculation
get_nc_thredds(cmip6.index = "http://esgdata.gfdl.noaa.gov/thredds/fileServer/gfdl_dataroot4/CMIP/NOAA-GFDL/GFDL-ESM4/historical/r1i1p1f1/Ofx/areacello/gr/v20190726/areacello_Ofx_GFDL-ESM4_historical_r1i1p1f1_gr.nc", save.path = "~/senior_thesis/cmip6_data")

global_flux(wd = "~/senior_thesis/cmip6_data",
            nc.file = 'areacello_Ofx_GFDL-ESM4_historical_r1i1p1f1_gr.nc',
            model.name = "GFDL")

```

19. Formatting data for plotting POC flux transects
```{r}
setwd("~/senior_thesis/")
source('calc_expc_transect.R')

#Atlantic Transect
calc_transect(lon = 10, save.name.st = "lon10_transect_st", save.name.lt = "lon10_transect_lt")

#Pacific Transect
calc_transect(lon = 205, save.name.st = "lon205_transect_st", save.name.lt = "lon205_transect_lt")

```

20. Plotting POC flux transects
```{r}
#loading objects
atlantic_st <- readRDS("~/senior_thesis/plotting_dataframes/lon10_transect_st.Rds")
atlantic_lt <- readRDS("~/senior_thesis/plotting_dataframes/lon10_transect_lt.Rds")
pacific_st <- readRDS("~/senior_thesis/plotting_dataframes/lon205_transect_st.Rds")
pacific_lt <- readRDS("~/senior_thesis/plotting_dataframes/lon205_transect_lt.Rds")
mean_MLD_max_2079_2099 <- readRDS("~/senior_thesis/plotting_dataframes/mean_MLD_max_2079_2099.Rds")
mean_MLD_max_2014_2033 <- readRDS("~/senior_thesis/plotting_dataframes/mean_MLD_max_2014_2033.Rds")

#I haven't fixed the title aspect of the plot_transect function, so be sure to change this manually before generating figures

#3 panel atlantic transect, full depth and zoomed in
plot_transect(lon = 10,
              save.name = "Atlantic_transect.png",
              save.name.zoom = "Atlantic_transect_1000m.png",
              transect.st = atlantic_st,
              transect.lt = atlantic_lt)

#3 panel pacific transect, full depth and zoomed in
plot_transect(lon = 205,
              save.name = "Pacific_transect.png",
              save.name.zoom = "Pacific_transect_1000m.png",
              transect.st = pacific_st,
              transect.lt = pacific_lt)


```

21. Calculate POC flux at 200m, 500m, 1000m for all models
```{r}

setwd('~/senior_thesis/')
source('libraries.R')
source('calc_expc_meters.R')

#every model but UKESM was averaged from 2015-2035 and 2079-2099, UKESM was 2015-2035 and 2077-2097

## CESM --------------

#this model has depth in cm not m, so change relevent section in the function, then change back for the rest of the models

#200m
calc_expc_meters(wd = "~/senior_thesis/combined_CESM_files",
                 nc.file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 model.name = "CESM",
                 start.st = 2,
                 start.lt = 66,
                 lon.length = 1:320,
                 lat.length = 1:384,
                 depth = 200)

#500m
calc_expc_meters(wd = "~/senior_thesis/combined_CESM_files",
                 nc.file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 model.name = "CESM",
                 start.st = 2,
                 start.lt = 66,
                 lon.length = 1:320,
                 lat.length = 1:384,
                 depth = 500)
#1000
calc_expc_meters(wd = "~/senior_thesis/combined_CESM_files",
                 nc.file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 model.name = "CESM",
                 start.st = 2,
                 start.lt = 66,
                 lon.length = 1:320,
                 lat.length = 1:384,
                 depth = 1000)

## CMCC ----------------

#200
calc_expc_meters(wd = "~/senior_thesis/combined_CMCC_files",
                 nc.file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "CMCC",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:362,
                 lat.length = 1:292,
                 depth = 200)
#500
calc_expc_meters(wd = "~/senior_thesis/combined_CMCC_files",
                 nc.file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "CMCC",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:362,
                 lat.length = 1:292,
                 depth = 500)
#1000
calc_expc_meters(wd = "~/senior_thesis/combined_CMCC_files",
                 nc.file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "CMCC",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:362,
                 lat.length = 1:292,
                 depth = 1000)

##EC-Earth ----------

#200
calc_expc_meters(wd = "~/senior_thesis/combined_EC-Earth_files",
                 nc.file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "EC-Earth",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:362,
                 lat.length = 1:292,
                 depth = 200)

#500
calc_expc_meters(wd = "~/senior_thesis/combined_EC-Earth_files",
                 nc.file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "EC-Earth",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:362,
                 lat.length = 1:292,
                 depth = 500)

#1000
calc_expc_meters(wd = "~/senior_thesis/combined_EC-Earth_files",
                 nc.file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "EC-Earth",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:362,
                 lat.length = 1:292,
                 depth = 1000)

##GFDL -------

#200
calc_expc_meters(wd = "~/senior_thesis/combined_GFDL_files",
                 nc.file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 model.name = "GFDL",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:360,
                 lat.length = 1:180,
                 depth = 200)

#500
calc_expc_meters(wd = "~/senior_thesis/combined_GFDL_files",
                 nc.file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 model.name = "GFDL",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:360,
                 lat.length = 1:180,
                 depth = 500)
#1000
calc_expc_meters(wd = "~/senior_thesis/combined_GFDL_files",
                 nc.file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 model.name = "GFDL",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:360,
                 lat.length = 1:180,
                 depth = 1000)

##MPI --------

#200
calc_expc_meters(wd = "~/senior_thesis/combined_MPI_files",
                 nc.file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "MPI",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:802,
                 lat.length = 1:404,
                 depth = 200)
#500
calc_expc_meters(wd = "~/senior_thesis/combined_MPI_files",
                 nc.file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "MPI",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:802,
                 lat.length = 1:404,
                 depth = 500)

#1000
calc_expc_meters(wd = "~/senior_thesis/combined_MPI_files",
                 nc.file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "MPI",
                 start.st = 1,
                 start.lt = 65,
                 lon.length = 1:802,
                 lat.length = 1:404,
                 depth = 1000)

##UKESM ----------

setwd('~/senior_thesis/')
source('calc_meters_UKESM.R')

#200
UKESM_meters(200)

#500
UKESM_meters(500)

#1000
UKESM_meters(1000)

```

22. Plot 3 panel figure showing short-term (2015-2035), long-term (2079-2099), and difference in average POC flux at 200m, 500m, 1000m
```{r}

source('plot_expc_meters.R')

#CESM
plot_expc_meters(wd = "~/senior_thesis/combined_CESM_files",
                 nc_file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 model.name = "CESM",
                 lat.name = "nlat",
                 lon.name = "nlon",
                 depth = 200)

#CMCC
plot_expc_meters(wd = "~/senior_thesis/combined_CMCC_files",
                 nc_file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "CMCC",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 200)

#EC-Earth
plot_expc_meters(wd = "~/senior_thesis/combined_EC-Earth_files",
                 nc_file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "EC-Earth",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 200)

#GFDL
plot_expc_meters(wd = "~/senior_thesis/combined_GFDL_files",
                 nc_file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 model.name = "GFDL",
                 lat.name = "lat",
                 lon.name = "lon",
                 depth = 200)

#MPI - uncheck y axis flip and source
plot_expc_meters(wd = "~/senior_thesis/combined_MPI_files",
                 nc_file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "MPI",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 200)

#UKESM
plot_expc_meters(wd = "~/senior_thesis/UKESM_data",
                 nc_file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
                 model.name = "UKESM",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 200)

## 500m -----------

#be sure to go change the depth in the titles first

#CESM
plot_expc_meters(wd = "~/senior_thesis/combined_CESM_files",
                 nc_file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 model.name = "CESM",
                 lat.name = "nlat",
                 lon.name = "nlon",
                 depth = 500)

#CMCC
plot_expc_meters(wd = "~/senior_thesis/combined_CMCC_files",
                 nc_file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "CMCC",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 500)

#EC-Earth
plot_expc_meters(wd = "~/senior_thesis/combined_EC-Earth_files",
                 nc_file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "EC-Earth",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 500)

#GFDL
plot_expc_meters(wd = "~/senior_thesis/combined_GFDL_files",
                 nc_file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 model.name = "GFDL",
                 lat.name = "lat",
                 lon.name = "lon",
                 depth = 500)

#MPI - uncheck y axis flip code
plot_expc_meters(wd = "~/senior_thesis/combined_MPI_files",
                 nc_file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "MPI",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 500)

#UKESM
plot_expc_meters(wd = "~/senior_thesis/UKESM_data",
                 nc_file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
                 model.name = "UKESM",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 500)

## 1000m ----------------

#CESM
plot_expc_meters(wd = "~/senior_thesis/combined_CESM_files",
                 nc_file = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 model.name = "CESM",
                 lat.name = "nlat",
                 lon.name = "nlon",
                 depth = 1000)

#CMCC
plot_expc_meters(wd = "~/senior_thesis/combined_CMCC_files",
                 nc_file = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "CMCC",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 1000)

#EC-Earth
plot_expc_meters(wd = "~/senior_thesis/combined_EC-Earth_files",
                 nc_file = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "EC-Earth",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 1000)

#GFDL
plot_expc_meters(wd = "~/senior_thesis/combined_GFDL_files",
                 nc_file = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 model.name = "GFDL",
                 lat.name = "lat",
                 lon.name = "lon",
                 depth = 1000)

#MPI - uncheck y axis flip code
plot_expc_meters(wd = "~/senior_thesis/combined_MPI_files",
                 nc_file = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 model.name = "MPI",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 1000)

#UKESM
plot_expc_meters(wd = "~/senior_thesis/UKESM_data",
                 nc_file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
                 model.name = "UKESM",
                 lat.name = "latitude",
                 lon.name = "longitude",
                 depth = 1000)

```

23. Plot 6 panel figures showing POC flux change in every model for 200m,500m, and 1000m
```{r}
#readPNG tends not to work in rstudio, so run these in the terminal

##200m --------------
setwd("~/senior_thesis/figures/")
A <- readPNG('CESM_200_expc_change.png')
B <- readPNG('CMCC_200_expc_change.png')
C <- readPNG('EC-Earth_200_expc_change.png')
D <- readPNG('GFDL_200_expc_change.png')
E <- readPNG('MPI_200_expc_change.png')
f <- readPNG('UKESM_200_expc_change.png')


grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_expc_200.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")

#500m ------------
setwd("~/senior_thesis/figures/")
A <- readPNG('CESM_500_expc_change.png')
B <- readPNG('CMCC_500_expc_change.png')
C <- readPNG('EC-Earth_500_expc_change.png')
D <- readPNG('GFDL_500_expc_change.png')
E <- readPNG('MPI_500_expc_change.png')
f <- readPNG('UKESM_500_expc_change.png')


grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_expc_500.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")

##1000m ---------------
setwd("~/senior_thesis/figures/")
A <- readPNG('CESM_1000_expc_change.png')
B <- readPNG('CMCC_1000_expc_change.png')
C <- readPNG('EC-Earth_1000_expc_change.png')
D <- readPNG('GFDL_1000_expc_change.png')
E <- readPNG('MPI_1000_expc_change.png')
f <- readPNG('UKESM_1000_expc_change.png')


grid.combine <- grid.arrange(rasterGrob(A),rasterGrob(B),rasterGrob(C),
                             rasterGrob(D),rasterGrob(E),rasterGrob(f),ncol=2, nrow=3)

ggsave(grid.combine, filename = "faceted_expc_1000.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 16, height = 12, units = "cm")

```

24. Calculating global flux of expc and epc100 for every year (1850-2100) in every model - to make time series figure
```{r}

setwd('~/senior_thesis/')
source('libraries.R')
source('get_time.R')
source('calc_time_series_epc100.R')

## CESM ---------------

#historical CESM 10/24/48 , 16 = 01/22/50
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'epc100_Omon_CESM2_historical_r10i1p1f1_gn_185001-201412.nc')

#future CESM 17 = 01/12/15
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'epc100_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc')

#CESM time series
time_series_100(wd = "~/senior_thesis/combined_CESM_files/",
                model.name = "CESM",
                his.name = 'epc100_Omon_CESM2_historical_r10i1p1f1_gn_185001-201412.nc',
                fut.name = 'epc100_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc',
                area.name = 'areacello_Ofx_CESM2_ssp585_r10i1p1f1_gn.nc',
                start.his = 16, end.his = 1961,
                start.fut = 17, end.fut = 1014)

## CMCC ---------------

#historical CMCC 17 = 01/12/15
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'epc100_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc')

get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'epc100_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc')

#CMCC time series
time_series_100(wd = "~/senior_thesis/combined_CMCC_files/",
                model.name = "CMCC",
                his.name = 'epc100_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                fut.name = 'epc100_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
                area.name = 'areacello_Ofx_CMCC-ESM2_historical_r1i1p1f1_gn.nc',
                start.his = 1, end.his = 1958,
                start.fut = 2, end.fut = 1011)

## EC-Earth ------------

#historical 
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'epc100_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc')

#future
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'epc100_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc')


#EC-Earth time series - still need historical data so can't calculate
time_series_100(wd = "~/senior_thesis/combined_EC-Earth_files/",
                model.name = "EC-Earth",
                his.name = 'epc100_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc',
                fut.name = 'epc100_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc',
                area.name = 'areacello_Ofx_EC-Earth3_historical_r1i1p1f1_gn.nc',
                start.his = 1, end.his = 1969,
                start.fut = 1, end.fut = 1021)

## GFDL -----------------

#GFDL historical
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'epc100_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc')

#GFDL future
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'epc100_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc')

#GFDL time series
time_series_100(wd = "~/senior_thesis/combined_GFDL_files/",
                model.name = "GFDL",
                his.name = 'epc100_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc',
                fut.name = 'epc100_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
                area.name = 'areacello_Ofx_GFDL-ESM4_historical_r1i1p1f1_gr.nc',
                start.his = 1, end.his = 1958,
                start.fut = 2, end.fut = 1011)

## MPI -------------

#MPI historical
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'epc100_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc')

#MPI future
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'epc100_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc')

#MPI time series - missing epc100 historical
time_series_100(wd = "~/senior_thesis/combined_MPI_files/",
                model.name = "MPI",
                his.name = 'epc100_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc',
                fut.name =  'epc100_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc',
                area.name = 'areacello_Ofx_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn.nc',
                start.his = 1, end.his = 1969,
                start.fut = 1, end.fut = 901)

## UKESM -------------

#UKESM historical
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'epc100_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc')

#UKESM future
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'epc100_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc')

#UKESM time series
time_series_100(wd = "~/senior_thesis/combined_UKESM_files/",
                model.name = "UKESM",
                his.name = 'epc100_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc', 
                fut.name = 'epc100_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
                area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                start.his = 1, end.his = 1961,
                start.fut = 1, end.fut = 1016)


```

25. Calculate globally integrated POC flux time series at MLDmax
```{r}

setwd('~/senior_thesis/')
source('libraries.R')
source('get_time.R')
source('calc_time_series_MLDmax.R')
source('calc_time_series_expc.R')

## CESM ----------

#wd = "~/senior_thesis/combined_CESM_files"
#nc.file = 'mlotst_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc'
#start.fut = 6
#end.fut = 1014
#model.name = "CESM"

#historical expc CESM
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'expc_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc')

#future expc CESM
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc')

#historical MLD CESM (1849-2013)
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'mlotst_Omon_CESM2_historical_r10i1p1f1_gn_185001-201412.nc')

#future MLD CESM (2014-2098)
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'mlotst_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc')

#creating yearly MLDmax arrays
time_series_MLDmax(wd = "~/senior_thesis/combined_CESM_files",
                   nc.file = 'mlotst_Omon_CESM2_ssp585_r10i1p1f1_gn_201501-210012.nc',
                   start.fut = 5, end.fut = 1014,
                   start.his = 4, end.his = 1961,
                   model.name = "CESM")

#calculating globally integrated POC flux at MLDmax from 1850-2100
time_series_expc(wd = "~/senior_thesis/combined_CESM_files",
                 model.name = "CESM",
                 fut.name = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_CESM2_ssp585_r10i1p1f1_gn.nc',
                 lon.length = 1:320,
                 lat.length = 1:384)

## CMCC --------------

# historical MLD (1850-2013)
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'mlotst_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc')

# future MLD (2015-2099)
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'mlotst_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc')

# historical expc
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'expc_Oyr_CMCC-ESM2_historical_r1i1p1f1_gn_1850-2014.nc')

#future expc
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc')

#creating yearly MLDmax arrays (1850-2099)
time_series_MLDmax(wd = "~/senior_thesis/combined_CMCC_files",
                   mlotst.his = 'mlotst_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                   mlotst.fut = 'mlotst_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
                   model.name = "CMCC",
                   start.his = 1, end.his = 1958,
                   start.fut = 2, end.fut = 1011)

#calculating globally integrated POC flux at MLDmax from 1850-2100
time_series_expc(wd = "~/senior_thesis/combined_CMCC_files",
                 model.name = "CMCC",
                 fut.name = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_CMCC-ESM2_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_CMCC-ESM2_historical_r1i1p1f1_gn.nc',
                 lon.length = 1:362,
                 lat.length = 1:292)


## GFDL ------------------

# historical MLD (1850-2013)
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'mlotst_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc')

# future MLD (2015 - 2099)
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'mlotst_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc')

# historical expc
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'expc_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc')

#future expc
get_time(data.path = "~/senior_thesis/combined_GFDL_files/",
         file.name = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc')

#creating yearly MLDmax arrays (1850-2099)
time_series_MLDmax(wd = "~/senior_thesis/combined_GFDL_files",
                   mlotst.his = 'mlotst_Omon_GFDL-ESM4_historical_r1i1p1f1_gr_185001-201412.nc',
                   mlotst.fut = 'mlotst_Omon_GFDL-ESM4_ssp585_r1i1p1f1_gr_201501-210012.nc',
                   model.name = "GFDL",
                   start.his = 1, end.his = 1958,
                   start.fut = 2, end.fut = 1011)

#calculating globally integrated POC flux at MLDmax from 1850-2100
time_series_expc(wd = "~/senior_thesis/combined_GFDL_files",
                 model.name = "GFDL",
                 fut.name = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 his.name = 'expc_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc',
                 area.name = 'areacello_Ofx_GFDL-ESM4_historical_r1i1p1f1_gr.nc',
                 lon.length = 1:360,
                 lat.length = 1:180)



##UKESM --------------

# special code because the files are too big to combine

setwd('~/senior_thesis/')
source('libraries.R')
source('get_time.R')
source('calc_time_series_expc_UKESM.R')

get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'mlotst_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc')

get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'mlotst_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc')


#creating yearly MLDmax array
time_series_MLDmax(wd = "~/senior_thesis/combined_UKESM_files",
                   mlotst.his = 'mlotst_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-201412.nc',
                   mlotst.fut = 'mlotst_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
                   model.name = "UKESM",
                   start.his = 1, end.his = 1961,
                   start.fut = 5, end.fut = 1016)

# 1) expc 1850-1900
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc')

UKESM_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc',
                      wd = "~/senior_thesis/combined_UKESM_files",
                      area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                      start.date = 1,
                      end.date = 585,
                      section = "1850_1900")

# 2) expc 1900-1950
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_190001-194912.nc')

UKESM_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_190001-194912.nc',
                      wd = "~/senior_thesis/combined_UKESM_files",
                      area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                      start.date = 10,
                      end.date = 593,
                      section = "1900_1950")

# 3) expc 1950-2000
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_195001-199912.nc')

UKESM_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_195001-199912.nc',
                      wd = "~/senior_thesis/combined_UKESM_files",
                      area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                      start.date = 6,
                      end.date = 578,
                      section = "1950_2000")

# 4) expc 2000-2015
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_200001-201412.nc')

UKESM_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_200001-201412.nc',
                      wd = "~/senior_thesis/combined_UKESM_files",
                      area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                      start.date = 3,
                      end.date = 161,
                      section = "2000_2015")

# 5) expc 2015-2050
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc')

UKESM_time_series_fut(file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
                      wd = "~/senior_thesis/combined_UKESM_files",
                      area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                      start.date = 5,
                      end.date = 407,
                      section = "2015_2050")

# 6) expc 2050-2100
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_205001-210012.nc')

UKESM_time_series_fut(file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_205001-210012.nc',
                      wd = "~/senior_thesis/combined_UKESM_files",
                      area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                      start.date = 12,
                      end.date = 596,
                      section = "2050_2100")

# 7) Combine csv files

#NOTE: Run this in a script, it doesn't work in the notebook for some reason
setwd("~/senior_thesis/plotting_dataframes/time_series/")
df.sep <- list.files("~/senior_thesis/plotting_dataframes/time_series/", pattern = "UKESM_time_series_")

#create empty list for storing for loop output
time.series <- list()

for(i in df.sep) {
  
  #read in csv file
  df <- read_csv(i)
  #store into list
  time.series[[i]] <- df
}

combined <- time.series %>%
  bind_rows

#delete duplicate year NA rows
combined <- combined[-c(51, 101), ]

write_csv(combined, "~/senior_thesis/plotting_dataframes/time_series/UKESM_time_series_expc.csv")


## MPI --------------------
#historical expc MPI
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'expc_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc')

#future expc MPI
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc')

#historical MLD MPI (1850-2014)
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'mlotst_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc')

#future MLD MPI (2015-2100)
get_time(data.path = "~/senior_thesis/combined_MPI_files/",
         file.name = 'mlotst_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc')

#create yearly MLDmax arrays
time_series_MLDmax(wd = "~/senior_thesis/combined_MPI_files",
                   mlotst.his = 'mlotst_Omon_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_185001-201412.nc',
                   mlotst.fut = 'mlotst_Omon_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_201501-210012.nc',
                   model.name = "MPI",
                   start.his = 1, end.his = 1969,
                   start.fut = 1, end.fut = 1021)

#calculating globally integrated POC flux at MLDmax from 1850-2100
time_series_expc(wd = "~/senior_thesis/combined_MPI_files",
                 model.name = "MPI",
                 fut.name = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn.nc',
                 lon.length = 1:802,
                 lat.length = 1:404)

## EC-Earth --------------
#historical expc MPI
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'expc_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc')

#future expc MPI
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc')

#historical MLD EC-Earth (1850-2014)
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'mlotst_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc')

#future MLD EC-Earth (2015-2100)
get_time(data.path = "~/senior_thesis/combined_EC-Earth_files/",
         file.name = 'mlotst_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc')

#create yearly MLDmax arrays
time_series_MLDmax(wd = "~/senior_thesis/combined_EC-Earth_files",
                   mlotst.his = 'mlotst_Omon_EC-Earth3-CC_historical_r1i1p1f1_gn_185001-201412.nc',
                   mlotst.fut = 'mlotst_Omon_EC-Earth3-CC_ssp585_r1i1p1f1_gn_201501-210012.nc',
                   model.name = "EC-Earth",
                   start.his = 1, end.his = 1969,
                   start.fut = 1, end.fut = 1021)

#calculating globally integrated POC flux at MLDmax from 1850-2100
time_series_expc(wd = "~/senior_thesis/combined_EC-Earth_files",
                 model.name = "EC-Earth",
                 fut.name = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_EC-Earth3-CC_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_EC-Earth3-CC_ssp585_r1i1p1f1_gn.nc',
                 lon.length = 1:362,
                 lat.length = 1:292)



```

26. Calculate globally integrated time series at 1000m depth horizon
```{r}

setwd('~/senior_thesis/')
source('libraries.R')
source('get_time.R')
source('calc_time_series_1000.R')

# CESM ---------

#calculating globally integrated POC flux at 1000m from 1850-2100
# v = 1:85 and 1:164
time_series_1000(wd = "~/senior_thesis/combined_CESM_files",
                 model.name = "CESM",
                 fut.name = 'expc_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_CESM2_ssp585_r10i1p1f1_gn.nc',
                 lon.length = 1:320,
                 lat.length = 1:384)

# CMCC ------------

# v = 1:85 and 1:164
time_series_1000(wd = "~/senior_thesis/combined_CMCC_files",
                 model.name = "CMCC",
                 fut.name = 'expc_Oyr_CMCC-ESM2_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_CMCC-ESM2_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_CMCC-ESM2_historical_r1i1p1f1_gn.nc',
                 lon.length = 1:362,
                 lat.length = 1:292)


# EC-Earth -------------

#v = 1:85 and 1:165
time_series_1000(wd = "~/senior_thesis/combined_EC-Earth_files",
                 model.name = "EC-Earth",
                 fut.name = 'expc_Oyr_EC-Earth3-CC_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_EC-Earth3-CC_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_EC-Earth3-CC_ssp585_r1i1p1f1_gn.nc',
                 lon.length = 1:362,
                 lat.length = 1:292)

# GFDL ----------------

#v = 1:85 and 1:164
time_series_1000(wd = "~/senior_thesis/combined_GFDL_files",
                 model.name = "GFDL",
                 fut.name = 'expc_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 his.name = 'expc_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc',
                 area.name = 'areacello_Ofx_GFDL-ESM4_historical_r1i1p1f1_gr.nc',
                 lon.length = 1:360,
                 lat.length = 1:180)

#MPI -----------

time_series_1000(wd = "~/senior_thesis/combined_MPI_files",
                 model.name = "MPI",
                 fut.name = 'expc_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'expc_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn.nc',
                 lon.length = 1:802,
                 lat.length = 1:404)

#UKESM --------------

# special code because the files are too big to combine

setwd('~/senior_thesis/')
source('libraries.R')
source('get_time.R')
source('calc_time_series_1000_UKESM.R')


# 1) expc 1850-1900 +0
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc')

UKESM_1000_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc',
                           wd = "~/senior_thesis/combined_UKESM_files",
                           area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                           start.date = 1,
                           end.date = 585,
                           year.seq = seq(from = 1850, to = 1898, by = 1),
                           section = "1850_1900")

# 2) expc 1900-1950 +50
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_190001-194912.nc')

UKESM_1000_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_190001-194912.nc',
                           wd = "~/senior_thesis/combined_UKESM_files",
                           area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                           start.date = 10,
                           end.date = 582,
                           year.seq = seq(from = 1900, to = 1947, by = 1),
                           section = "1900_1950")

# 3) expc 1950-2000 +98
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_195001-199912.nc')

UKESM_1000_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_195001-199912.nc',
                           wd = "~/senior_thesis/combined_UKESM_files",
                           area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                           start.date = 6,
                           end.date = 578,
                           year.seq = seq(from = 1948, to = 1996, by = 1),
                           section = "1950_2000")

# 4) expc 2000-2015 +148
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_200001-201412.nc')

UKESM_1000_time_series_his(file = 'expc_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_200001-201412.nc',
                           wd = "~/senior_thesis/combined_UKESM_files",
                           area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                           start.date = 3,
                           end.date = 161,
                           year.seq = seq(from = 1998, to = 2011, by = 1),
                           section = "2000_2015")

# 5) expc 2015-2050 +0
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc')

UKESM_1000_time_series_fut(file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-204912.nc',
                           wd = "~/senior_thesis/combined_UKESM_files",
                           area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                           start.date = 5,
                           end.date = 407,
                           year.seq = seq(from = 2013, to = 2046, by = 1),
                           section = "2015_2050")

# 6) expc 2050-2100 +36
get_time(data.path = "~/senior_thesis/combined_UKESM_files/",
         file.name = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_205001-210012.nc')

UKESM_1000_time_series_fut(file = 'expc_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_205001-210012.nc',
                           wd = "~/senior_thesis/combined_UKESM_files",
                           area.name = 'areacello_Ofx_UKESM1-0-LL_piControl_r1i1p1f2_gn.nc',
                           start.date = 12,
                           end.date = 596,
                           year.seq = seq(from = 2048, to = 2096, by = 1),
                           section = "2050_2100")

# 7) Combine csv files

#NOTE: Run this in a script, it doesn't work in the notebook for some reason
setwd("~/senior_thesis/plotting_dataframes/time_series/")
df.sep <- list.files("~/senior_thesis/plotting_dataframes/time_series/", pattern = "UKESM_1000_time_series_")

#create empty list for storing for loop output
time.series <- list()

for(i in df.sep) {
  
  #read in csv file
  df <- read_csv(i)
  #store into list
  time.series[[i]] <- df
}

combined <- time.series %>%
  bind_rows



write_csv(combined, "~/senior_thesis/plotting_dataframes/time_series/UKESM_time_series_1000.csv")


```


27. Plotting time series figures
```{r}

#plot 100m and MLDmax time series, normalized 100m and MLDmax time series
source("plot_time_series.R")

#PLOTTING NORMALIZED 100M, MLDMAX, and 1000m IN SAME PLOT -------

#read in combined expc and epc100 time series

n_epc100_all <- read_csv("~/senior_thesis/plotting_dataframes/time_series/normalized_time_series_epc100.csv")
n_expc_all <- read_csv("~/senior_thesis/plotting_dataframes/time_series/normalized_time_series_expc.csv")
n_1000_all <- read_csv("~/senior_thesis/plotting_dataframes/time_series/1000_time_series_normalized.csv")

#rename MLDmax columns
n_expc_all <- rename(n_expc_all, CESM_expc = CESM)
n_expc_all <- rename(n_expc_all, CMCC_expc = CMCC)
n_expc_all <- rename(n_expc_all, 'EC-Earth_expc' = 'EC-Earth')
n_expc_all <- rename(n_expc_all, GFDL_expc = GFDL)
n_expc_all <- rename(n_expc_all, MPI_expc = MPI)
n_expc_all <- rename(n_expc_all, UKESM_expc = UKESM)

#rename 1000m columns
n_1000_all <- rename(n_1000_all, CESM_1000 = CESM)
n_1000_all <- rename(n_1000_all, CMCC_1000 = CMCC)
n_1000_all <- rename(n_1000_all, 'EC-Earth_1000' = 'EC-Earth')
n_1000_all <- rename(n_1000_all, GFDL_1000 = GFDL)
n_1000_all <- rename(n_1000_all, MPI_1000 = MPI)
n_1000_all <- rename(n_1000_all, UKESM_1000 = UKESM)

#combine 100m and MLDmax and 1000m data frames
df.both <- left_join( n_epc100_all, n_expc_all, by = "Year")
df.all <- left_join(df.both, n_1000_all, by = "Year")


setwd("~/senior_thesis/")
source('plot_faceted_time_series.R')

faceted_ts("CESM")
faceted_ts("CMCC")
faceted_ts("EC-Earth")
faceted_ts("GFDL")
faceted_ts("MPI")
faceted_ts("UKESM")


#be sure to run readPNG in a script not the notebook or else it glitches
setwd("~/senior_thesis/figures/time_series/")
A <- readPNG('CESM_time_series_DH_comparison.png')
B <- readPNG('CMCC_time_series_DH_comparison.png')
C <- readPNG('EC-Earth_time_series_DH_comparison.png')
D <- readPNG('GFDL_time_series_DH_comparison.png')
E <- readPNG('MPI_time_series_DH_comparison.png')
f <- readPNG('UKESM_time_series_DH_comparison.png')

grid.combine <- grid.arrange(rasterGrob(B),rasterGrob(A),rasterGrob(E),
                             rasterGrob(D),rasterGrob(f), rasterGrob(C), ncol=3, nrow=2)

ggsave(grid.combine, filename = "faceted_DH_comparison.png", device = "png", path = "~/senior_thesis/figures/faceted/", 
       dpi = 500, width = 22, height = 10, units = "cm")

```


28. Plot NPP sample depth profile
```{r}
setwd("~/senior_thesis/")
source("NPP_evaluating.R")

#CESM - yr
npp_profile(wd = "~/senior_thesis/combined_CESM_files/",
            nc_file = "pp_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc",
            model.name = "CESM")

#CMCC - mon
npp_profile(wd = "~/senior_thesis/combined_CMCC_files/",
            nc_file = "pp_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc",
            model.name = "CMCC")

#EC-Earth - missing data
npp_profile(wd = "~/senior_thesis/combined_EC-Earth_files/",
            nc_file = "pp_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc",
            model.name = "EC-Earth")

#GFDL - yr
npp_profile(wd = "~/senior_thesis/combined_GFDL_files/",
            nc_file = "pp_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc",
            model.name = "GFDL")

#MPI - yr
npp_profile(wd = "~/senior_thesis/combined_MPI_files/",
            nc_file = "pp_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc",
            model.name = "MPI")

#UKESM
npp_profile(wd = "~/senior_thesis/combined_UKESM_files/",
            nc_file = "pp_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc",
            model.name = "UKESM")

```

29. Calculate column-integrated NPP averages - long-term (2079-2099) and historical (1850-1900)
```{r}

setwd("~/senior_thesis/")
source('libraries.R')
source('get_time.R')
source('calc_NPP.R')

## CESM --------------

#go into function and convert from cm to m (just for this model)

#start = 03/01/14, end = 02/08/99
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'pp_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc')

#Z length: 15

calc_npp_avg(wd = "~/senior_thesis/combined_CESM_files",
             nc.file = 'pp_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
             model.name = "CESM",
             start.lt = 66,
             lon.length = 1:320,
             lat.length = 1:384)

#historical
get_time(data.path = "~/senior_thesis/combined_CESM_files/",
         file.name = 'pp_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc')

calc_npp_avg_his(wd = "~/senior_thesis/combined_CESM_files",
                 nc.file = 'pp_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc',
                 model.name = "CESM",
                 start.his = 2,
                 lon.length = 1:320,
                 lat.length = 1:384)

## CMCC -----------

#start = 03/01/14, end = 02/08/99
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'pp_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc')

#Z length = 50

calc_npp_avg(wd = "~/senior_thesis/combined_CMCC_files",
             nc.file = 'pp_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
             model.name = "CMCC",
             start.lt = 771,
             lon.length = 1:362,
             lat.length = 1:292)

#historical
get_time(data.path = "~/senior_thesis/combined_CMCC_files/",
         file.name = 'pp_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc')

calc_npp_avg_his(wd = "~/senior_thesis/combined_CMCC_files",
                 nc.file = 'pp_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                 model.name = "CMCC",
                 start.his = 1,
                 lon.length = 1:362,
                 lat.length = 1:292)

## EC-Earth ---------

#MISSING DATA


## GFDL ---------

get_time(data.path = "~/senior_thesis/combined_GFDL_files/", file.name = 'pp_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc')

#Z length = 35

calc_npp_avg(wd = "~/senior_thesis/combined_GFDL_files",
             nc.file = 'pp_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
             model.name = "GFDL",
             start.lt = 65,
             lon.length = 1:360,
             lat.length = 1:180)

get_time(data.path = "~/senior_thesis/combined_GFDL_files/", file.name = 'pp_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc')

calc_npp_avg_his(wd = "~/senior_thesis/combined_GFDL_files",
                 nc.file = 'pp_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc',
                 model.name = "GFDL",
                 start.his = 1,
                 lon.length = 1:360,
                 lat.length = 1:180)

## MPI ----------

get_time(data.path = "~/senior_thesis/combined_MPI_files/", file.name = 'pp_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc')

#Z length = 40

calc_npp_avg(wd = "~/senior_thesis/combined_MPI_files",
             nc.file = 'pp_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
             model.name = "MPI",
             start.lt = 45,
             lon.length = 1:802,
             lat.length = 1:404)

get_time(data.path = "~/senior_thesis/combined_MPI_files/", file.name = 'pp_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc')

calc_npp_avg_his(wd = "~/senior_thesis/combined_MPI_files",
                 nc.file = 'pp_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc',
                 model.name = "MPI",
                 start.his = 1,
                 lon.length = 1:802,
                 lat.length = 1:404)

#note for completing time series calcs - this file is missing a couple years

## UKESM ----------

get_time(data.path = "~/senior_thesis/combined_UKESM_files/", file.name = 'pp_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc')

#Z length = 75

#had to take this one's average from 2076-2096 due to missing end of 21st century data
calc_npp_avg(wd = "~/senior_thesis/combined_UKESM_files",
             nc.file = 'pp_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
             model.name = "UKESM",
             start.lt = 785,
             lon.length = 1:360,
             lat.length = 1:330)

get_time(data.path = "~/senior_thesis/combined_UKESM_files/", file.name = 'pp_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc')

calc_npp_avg_his(wd = "~/senior_thesis/combined_UKESM_files",
                 nc.file = 'pp_Omon_UKESM1-0-LL_historical_r1i1p1f2_gn_185001-189912.nc',
                 model.name = "UKESM",
                 start.his = 1,
                 lon.length = 1:360,
                 lat.length = 1:330)

```

30. Plot global maps of column integrated NPP - long-term, historical, and change
```{r}
setwd("~/senior_thesis/")
source('libraries.R')
source('plot_NPP.R')

## CESM ------------


plot_NPP(wd = "~/senior_thesis/combined_CESM_files/",
         nc.file = 'pp_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
         model.name = "CESM",
         lat.name = "nlat",
         lon.name = "nlon")

# CMCC ------------


plot_NPP(wd = "~/senior_thesis/combined_CMCC_files/",
         nc.file = 'pp_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
         model.name = "CMCC",
         lat.name = "latitude",
         lon.name = "longitude")

# GFDL ---------

plot_NPP(wd = "~/senior_thesis/combined_GFDL_files/",
         nc.file = 'pp_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
         model.name = "GFDL",
         lat.name = "lat",
         lon.name = "lon")

# MPI --------

plot_NPP(wd = "~/senior_thesis/combined_MPI_files/",
         nc.file = 'pp_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
         model.name = "MPI",
         lat.name = "latitude",
         lon.name = "longitude")

# UKESM ---------

plot_NPP(wd = "~/senior_thesis/combined_UKESM_files/",
         nc.file = 'pp_Omon_UKESM1-0-LL_ssp585_r1i1p1f2_gn_201501-210012.nc',
         model.name = "UKESM",
         lat.name = "latitude",
         lon.name = "longitude")

```

31. Calculate globally integrated NPP time series (1850-2100)
```{r}

setwd("~/senior_thesis/")
source("libraries.R")
source("get_time.R")
source("calc_time_series_npp.R")

## CESM --------------

#Z length = 15
time_series_npp(wd = "~/senior_thesis/combined_CESM_files",
                model.name = "CESM",
                fut.name = 'pp_Oyr_CESM2_ssp585_r10i1p1f1_gn_2015-2100.nc',
                his.name = 'pp_Oyr_CESM2_historical_r10i1p1f1_gn_1850-2014.nc',
                area.name = 'areacello_Ofx_CESM2_ssp585_r10i1p1f1_gn.nc',
                lon.length = 1:320,
                lat.length = 1:384)

## CMCC --------------

# v = 1:85 and 1:164
#Z length = 50
time_series_npp(wd = "~/senior_thesis/combined_CMCC_files",
                 model.name = "CMCC",
                 fut.name = 'pp_Omon_CMCC-ESM2_ssp585_r1i1p1f1_gn_201501-210012.nc',
                 his.name = 'pp_Omon_CMCC-ESM2_historical_r1i1p1f1_gn_185001-201412.nc',
                 area.name = 'areacello_Ofx_CMCC-ESM2_historical_r1i1p1f1_gn.nc',
                 lon.length = 1:362,
                 lat.length = 1:292)


## EC-Earth -------------

#missing data

## GFDL ----------------

#v = 1:85 and 1:164
#Z length = 35
time_series_npp(wd = "~/senior_thesis/combined_GFDL_files",
                 model.name = "GFDL",
                 fut.name = 'pp_Oyr_GFDL-ESM4_ssp585_r1i1p1f1_gr_2015-2100.nc',
                 his.name = 'pp_Oyr_GFDL-ESM4_historical_r1i1p1f1_gr_1850-2014.nc',
                 area.name = 'areacello_Ofx_GFDL-ESM4_historical_r1i1p1f1_gr.nc',
                 lon.length = 1:360,
                 lat.length = 1:180)

#MPI -----------

#Z length = 50
time_series_npp(wd = "~/senior_thesis/combined_MPI_files",
                 model.name = "MPI",
                 fut.name = 'pp_Oyr_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn_2015-2100.nc',
                 his.name = 'pp_Oyr_MPI-ESM1-2-HR_historical_r1i1p1f1_gn_1850-2014.nc',
                 area.name = 'areacello_Ofx_MPI-ESM1-2-HR_ssp585_r1i1p1f1_gn.nc',
                 lon.length = 1:802,
                 lat.length = 1:404)


```

